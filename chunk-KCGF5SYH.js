import{a as $}from"./chunk-LQMJWFCQ.js";import{Ka as G,c as o,ga as u,la as S,s as l,t as M,z as y}from"./chunk-NPSVTU3I.js";import{e as c}from"./chunk-JKOY2XUY.js";var j=(()=>{class i{constructor(){this.initIndexedDB()}static{this.STORE_NAME_KEY_VALUES="key_values"}static{this.STORE_NAME_TYPES="types"}static{this.STORE_NAME_MARKET_GROUPS="market_groups"}static{this.STORE_NAME_GRAPHICS="graphics"}static{this.STORE_NAME_REGIONS="regions"}static{this.STORE_NAME_CONSTELLATIONS="constellations"}static{this.STORE_NAME_SYSTEMS="systems"}static{this.STORE_NAME_REGION_ORDERS="region_orders"}initIndexedDB(){this.request=indexedDB.open("eve_helper",7),this.request.onupgradeneeded=e=>{let t=e.target.result,r=e.newVersion??0,s=e.oldVersion??0;if(r!=s){if(s<1&&t.createObjectStore(i.STORE_NAME_KEY_VALUES,{keyPath:"key"}),s<4&&(t.createObjectStore(i.STORE_NAME_TYPES,{keyPath:"type_id"}),t.createObjectStore(i.STORE_NAME_MARKET_GROUPS,{keyPath:"market_group_id"})),s<5&&t.createObjectStore(i.STORE_NAME_GRAPHICS,{keyPath:"graphic_id"}),s<6){t.createObjectStore(i.STORE_NAME_REGIONS,{keyPath:"region_id"}),t.createObjectStore(i.STORE_NAME_CONSTELLATIONS,{keyPath:"constellation_id"}).createIndex("region_id","region_id",{unique:!1});let a=t.createObjectStore(i.STORE_NAME_SYSTEMS,{keyPath:"system_id"});a.createIndex("constellation_id","constellation_id",{unique:!1}),a.createIndex("star_id","star_id",{unique:!1})}s<7&&t.createObjectStore(i.STORE_NAME_REGION_ORDERS,{keyPath:"regionId"}),console.debug("IndexedDBManagerService.initIndexedDB DONE")}},this.request.onsuccess=e=>{this.db=e.target.result},this.request.onerror=e=>{console.error("\u6570\u636E\u5E93\u6253\u5F00\u5931\u8D25")}}getObjectStore(e){return new o(t=>{this.getDB().subscribe(r=>{let n=r.transaction(e,"readwrite").objectStore(e);t.next(n),t.complete()})})}getDB(){return new o(e=>{this.db?(e.next(this.db),e.complete()):setTimeout(()=>{this.getDB().subscribe(t=>{e.next(t),e.complete()})},3e3)})}clearDB(){return new o(e=>{setTimeout(()=>c(this,null,function*(){(yield l(this.getDB())).close();let r=indexedDB.deleteDatabase("eve_helper");r.onsuccess=()=>{e.next(),e.complete()},r.onerror=s=>{e.error(s)}}))})}dbRequestGetOrDefault(e,t=null){return new o(r=>{e.onsuccess=s=>{let n=s.target?.result??void 0;n===void 0?r.next(t):r.next(n.value),r.complete()},e.onerror=s=>{console.error("IndexedDBManagerService.getOrDefault",s),r.next(t),r.complete()}})}dbRequestWait(e){return new o(t=>{e.onsuccess=r=>{t.next(),t.complete()},e.onerror=r=>{console.error("IndexedDBManagerService.dbRequestWait",r),t.error(r)}})}getRegionOrderStore(){return this.getObjectStore(i.STORE_NAME_REGION_ORDERS)}getKeyValueStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_KEY_VALUES).subscribe(t=>{e.next(t),e.complete()})})}getTypeStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_TYPES).subscribe(t=>{e.next(t),e.complete()})})}getMarketGroupStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_MARKET_GROUPS).subscribe(t=>{e.next(t),e.complete()})})}getGraphicStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_GRAPHICS).subscribe(t=>{e.next(t),e.complete()})})}getRegionStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_REGIONS).subscribe(t=>{e.next(t),e.complete()})})}getConstellationStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_CONSTELLATIONS).subscribe(t=>{e.next(t),e.complete()})})}getSystemStore(){return new o(e=>{this.getObjectStore(i.STORE_NAME_SYSTEMS).subscribe(t=>{e.next(t),e.complete()})})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function f(){return{key:"",name:"",doneStep:0,totalStep:0}}var _=class{static randomInt(p,e){return Math.floor(Math.random()*(e-p+1))+p}};var O=class{static wait(p){return new o(e=>{setTimeout(()=>{e.next(),e.complete()},p)})}static timestampMS(){return Date.now()}};var C=(()=>{class i{constructor(e){this.zone=e,this.showItemChangeTime=0,this.currentKey="",this.itemDict={},this.finishedStep=0,this.startIntervalRefresh()}get isLoading(){return Object.keys(this.itemDict).length>0}get showItem(){if(!this.isLoading)return f();let e=f();e.key="total",e.doneStep+=this.finishedStep,e.totalStep+=this.finishedStep;for(let n in this.itemDict){let a=this.itemDict[n];e.doneStep+=a.doneStep,e.totalStep+=a.totalStep}let t=this.currentKey,r=O.timestampMS();if(r-i.SHOW_ITEM_CHANGE_INTERVAL>this.showItemChangeTime){let n=Object.keys(this.itemDict),a=_.randomInt(0,n.length-1);t=n[a],this.currentKey=t,this.showItemChangeTime=r}let s=this.itemDict[t];return e.name=s?.name??"",e}static{this.SHOW_ITEM_CHANGE_INTERVAL=5e3}register(e,t,r){let s=f();return s.key=e,s.name=t,s.doneStep=0,s.totalStep=r,this.itemDict[e]=s,s}finished(e){this.finishedStep+=e.totalStep,delete this.itemDict[e.key]}startIntervalRefresh(){this.zone.runOutsideAngular(()=>{setInterval(()=>{if(!this.isLoading)return;let e=this.register("_"," ",0);this.finished(e)},i.SHOW_ITEM_CHANGE_INTERVAL)})}static{this.\u0275fac=function(t){return new(t||i)(S(G))}}static{this.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function D(i,p){return{regionId:i,orders:p,mtime:O.timestampMS()}}var h="https://esi.evetech.net/latest",w=`${h}/universe/types`,te=`${h}/universe/names`,x=`${h}/universe/categories`,I=`${h}/universe/groups`,N=`${h}/markets/groups`,A=`${h}/universe/graphics`,b=`${h}/universe/regions`;function v(i,p){return`${h}/markets/${i}/history?datasource=tranquility&type_id=${p}`}function V(i,p="all",e=1,t){let r=`${h}/markets/${i}/orders/?datasource=tranquility&order_type=${p}&page=${e}`;return t&&(r=r+=`&type_id=${t}`),r}var U=(()=>{class i{constructor(e){this.httpClient=e}universeTypes(){return new o(e=>{setTimeout(()=>c(this,null,function*(){let t=yield l(this.httpClient.get(w));e.next(t),e.complete()}))})}universeType(e){return new o(t=>{setTimeout(()=>c(this,null,function*(){let r=yield l(this.httpClient.get(`${w}/${e}`));t.next(r),t.complete()}))})}universeCategories(){return new o(e=>{setTimeout(()=>c(this,null,function*(){let t=yield l(this.httpClient.get(x));e.next(t),e.complete()}))})}universeCategory(e){return new o(t=>{this.httpClient.get(`${x}/${e}`).subscribe(r=>{t.next(r),t.complete()})})}universeGroups(){return new o(e=>{this.httpClient.get(I).subscribe(t=>{e.next(t),e.complete()})})}universeGroup(e){return new o(t=>{this.httpClient.get(`${I}/${e}`).subscribe(r=>{t.next(r),t.complete()})})}marketsGroups(){return new o(e=>{this.httpClient.get(N).subscribe(t=>{e.next(t),e.complete()})})}marketsGroup(e){return new o(t=>{this.httpClient.get(`${N}/${e}`).subscribe(r=>{r?t.next(r):t.next(null),t.complete()})})}universeGraphics(){return new o(e=>{setTimeout(()=>c(this,null,function*(){let t=yield l(this.httpClient.get(A));e.next(t),e.complete()}))})}universeGraphic(e){return new o(t=>{setTimeout(()=>c(this,null,function*(){let r=yield l(this.httpClient.get(`${A}/${e}`));t.next(r),t.complete()}))})}universeRegions(){return new o(e=>{setTimeout(()=>c(this,null,function*(){let t=yield l(this.httpClient.get(`${b}`));e.next(t),e.complete()}))})}universeRegion(e){return new o(t=>{setTimeout(()=>c(this,null,function*(){let r=yield l(this.httpClient.get(`${b}/${e}`));t.next(r),t.complete()}))})}marketsRegionHistory(e,t){return new o(r=>{this.httpClient.get(v(e,t)).subscribe(s=>{r.next(s),r.complete()})})}marketsRegionOrders(e,t="all",r=1,s){return new o(n=>{setTimeout(()=>c(this,null,function*(){this.httpClient.get(V(e,t,r,s)).subscribe({next:a=>{n.next(a),n.complete()},error:a=>{console.error(`EveEsiApi.marketsRegionOrders get region[${e}] orders[${r}] failed`,a),n.next([]),n.complete()}})}))})}static{this.\u0275fac=function(t){return new(t||i)(S($))}}static{this.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ce=(()=>{class i{constructor(e,t,r){this.indexedDBManager=e,this.loadingViewManager=t,this.eveEsiApi=r,this.loadingDict={},this.loadingSubscribersDict={}}reloadOrdersByRegionId(e){if(this.loadingDict[e])return new o(s=>{this.loadingSubscribersDict[e]||(this.loadingSubscribersDict[e]=[]),this.loadingSubscribersDict[e].push(s)});this.loadingDict[e]=!0;let t=this.loadingViewManager.register(`OrderRepositoryService.reloadOrdersByRegionId:{${e}}`,"\u661F\u57DF\u8BA2\u5355",1);return new o(r=>{setTimeout(()=>c(this,null,function*(){let s=1,n=[],a=!0;do{let E=[];for(let g=0;g<10;g++)E.push(this.eveEsiApi.marketsRegionOrders(e,"all",s)),s++;let d=yield l(y(E));for(let g in d){let k=d[g];n.push(...k),k.length==0&&(a=!1)}t.doneStep+=1,t.totalStep+=1}while(a);console.debug(`OrderRepositoryService.reloadOrdersByRegionId putting region[${e}] orders[${n.length}]`);let m=(yield l(this.indexedDBManager.getRegionOrderStore())).put(D(e,n));m.onsuccess=()=>{r.next(),r.complete()},m.onerror=E=>{console.error(`OrderRepositoryService.reloadOrdersByRegionId put region[${e}] failed`,E),r.next(),r.complete()}}))}).pipe(M(()=>{if(this.loadingViewManager.finished(t),this.loadingDict[e]=!1,this.loadingSubscribersDict[e]){let r=this.loadingSubscribersDict[e];for(let s in r){let n=r[s];n.next(),n.complete()}}}))}getOrdersByRegionId(e){return new o(t=>{setTimeout(()=>c(this,null,function*(){let s=(yield l(this.indexedDBManager.getRegionOrderStore())).get(e);s.onsuccess=()=>{s.result===void 0?this.reloadOrdersByRegionId(e).subscribe(()=>{setTimeout(()=>c(this,null,function*(){let n=yield l(this.getOrdersByRegionId(e));t.next(n),t.complete()}))}):(t.next(s.result),t.complete())},s.onerror=n=>{console.error(`OrderRepositoryService.getOrdersByRegionId get region[${e}] failed`,n),t.next(null),t.complete()}}))})}getOrdersByTypeId(e,t){return new o(r=>{setTimeout(()=>c(this,null,function*(){let s=yield l(this.hasDBOrdersByRegionId(e)),n=[];if(s){let a=yield l(this.getOrdersByRegionId(e));if(a===null){r.next(n),r.complete();return}for(let R in a.orders){let m=a.orders[R];m.type_id==t&&n.push(m)}}else{let a=!0,R=1;do{let m=[];for(let d=0;d<10;d++)m.push(this.eveEsiApi.marketsRegionOrders(e,"all",R,t)),R++;let E=yield l(y(m));for(let d in E){let g=E[d];n.push(...g),g.length==0&&(a=!1)}}while(a)}r.next(n),r.complete()}))})}hasDBOrdersByRegionId(e){return new o(t=>{setTimeout(()=>c(this,null,function*(){let s=(yield l(this.indexedDBManager.getRegionOrderStore())).get(e);s.onsuccess=()=>{t.next(s.result!==void 0)},s.onerror=n=>{console.error(`OrderRepositoryService.hasDBOrdersByRegionId get region[${e}] failed`,n),t.next(!1),t.complete()}}))})}static{this.\u0275fac=function(t){return new(t||i)(S(j),S(C),S(U))}}static{this.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{O as a,j as b,C as c,U as d,ce as e};
